<form method="POST" action="{{ url_for('agregar') }}">
  <div class="modal-header">
    <h5 class="modal-title">Agregar Producto</h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
  </div>
  <div class="modal-body">
    <div class="mb-3">
      <label for="nombre" class="form-label">Nombre</label>
      <input type="text" class="form-control" name="nombre" id="nombre" required>
    </div>

    <div class="mb-3">
      <label for="cantidad" class="form-label">Cantidad</label>
      <input type="number" class="form-control" name="cantidad" id="cantidad" required>
    </div>

    <div class="mb-3">
      <label for="stock_minimo" class="form-label">Stock MÃ­nimo</label>
      <input type="number" class="form-control" name="stock_minimo" id="stock_minimo" required>
    </div>

    <div class="mb-3">
      <label for="precio_costo" class="form-label">Precio de Costo</label>
      <div class="input-group">
        <span class="input-group-text">$</span>
        <input type="text" class="form-control" name="precio_costo" id="precio_costo" required>
      </div>
    </div>

    <div class="mb-3">
      <label for="ganancia" class="form-label">% Ganancia</label>
      <input type="text" class="form-control" name="ganancia" id="ganancia">
    </div>

    <div class="mb-3">
      <label for="precio_venta" class="form-label">Precio de Venta (Calculado)</label>
      <div class="input-group">
        <span class="input-group-text">$</span>
        <input type="text" class="form-control" id="precio_venta" readonly>
      </div>
    </div>

    <div class="mb-3">
      <label for="proveedor" class="form-label">Proveedor</label>
      <input type="text" class="form-control" name="proveedor" id="proveedor">
    </div>
  </div>
  <div class="modal-footer">
    <button type="submit" class="btn btn-primary">Guardar</button>
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
  </div>
</form>

<script>
function parsearNumero(valor) {
    if (!valor) return NaN;
    valor = valor.toString().trim();
    if (/^\d+(\.\d+)?$/.test(valor)) {
        return parseFloat(valor);
    }
    return parseFloat(valor.replace(/\./g, "").replace(",", "."));
}

function calcularPrecioVenta() {
    let costo = parsearNumero(document.getElementById("precio_costo")?.value);
    let ganancia = parsearNumero(document.getElementById("ganancia")?.value);
    if (!isNaN(costo) && !isNaN(ganancia)) {
        let precioVenta = costo * (1 + (ganancia / 100));
        if (document.getElementById("precio_venta")) {
            document.getElementById("precio_venta").value = precioVenta.toLocaleString("es-AR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    } else if (document.getElementById("precio_venta")) {
        document.getElementById("precio_venta").value = "";
    }
}

setTimeout(() => {
  calcularPrecioVenta();
  document.getElementById("precio_costo")?.addEventListener("input", calcularPrecioVenta);
  document.getElementById("ganancia")?.addEventListener("input", calcularPrecioVenta);
}, 100);
</script>
