{% extends "layout.html" %}
{% block title %}Inventario{% endblock %}
{% block content %}
<h2>Inventario</h2>

<!-- üîπ Tarjetas resumen de totales -->
<div class="row mb-3">
    <div class="col-md-4">
        <div class="card resumen-card bg-danger text-white text-center">
            <div class="card-body">
                <h5 class="card-title">Costo Total en Stock</h5>
                <h3>$ {{ total_costo|precio }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card resumen-card bg-primary text-white text-center">
            <div class="card-body">
                <h5 class="card-title">Valor de Venta Total</h5>
                <h3>$ {{ total_venta|precio }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card resumen-card {% if ganancia < 0 %}bg-danger{% else %}bg-success{% endif %} text-white text-center">
            <div class="card-body">
                <h5 class="card-title">Ganancia Potencial</h5>
                <h3>$ {{ ganancia|precio }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- üîπ Buscador din√°mico -->
<div class="input-group mb-3">
    <input type="text" id="buscador" class="form-control" placeholder="üîç Buscar producto o proveedor">
    <button type="button" class="btn btn-secondary" onclick="limpiarBusqueda()">‚ùå Limpiar</button>
</div>

<!-- Bot√≥n Agregar con modal -->
<button class="btn btn-success mb-3" onclick="abrirModalAgregar()">‚ûï Agregar Producto</button>

<!-- üîπ Contenedor con scroll para mantener el bot√≥n siempre visible -->
<div style="max-height: 55vh; overflow-y: auto; border: 1px solid #ddd;">
<table class="table table-striped">
<thead class="table-dark" style="position: sticky; top: 0;">
<tr>
  <th>Nombre</th>
  <th>Cantidad en Stock</th>
  <th>Stock M√≠nimo</th>
  <th>Precio Costo</th>
  <th>% Ganancia</th>
  <th>Precio Venta</th>
  <th>Proveedor</th>
  <th>Acciones</th>
</tr>
</thead>
<tbody>
{% for p in productos %}
<tr class="{% if p['cantidad'] <= p['stock_minimo'] %}table-danger{% endif %}">
  <td>{{ p['nombre'] }}</td>
  <td>{{ p['cantidad'] }}</td>
  <td>{{ p['stock_minimo'] }}</td>
  <td>$ {{ p['precio_costo']|precio }}</td>
  <td>{{ p['ganancia'] }}%</td>
  <td>$ {{ p['precio_venta']|precio }}</td>
  <td>{{ p['proveedor'] }}</td>
  <td>
    <button class="btn btn-sm btn-primary" onclick="abrirModalEditar({{ p['id'] }})">Editar</button>
    <a href="{{ url_for('eliminar', id=p['id']) }}" class="btn btn-sm btn-danger" onclick="return confirm('¬øEliminar este producto?')">Eliminar</a>
  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("buscador");
    const filas = document.querySelectorAll("table tbody tr");

    if (localStorage.getItem("busquedaInventario")) {
        input.value = localStorage.getItem("busquedaInventario");
    }

    function filtrar() {
        let filtro = input.value.toLowerCase();
        filas.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(filtro) ? "" : "none";
        });
        localStorage.setItem("busquedaInventario", filtro);
    }

    input.addEventListener("keyup", filtrar);
    filtrar();
});

function limpiarBusqueda() {
    localStorage.removeItem("busquedaInventario");
    location.reload();
}

function abrirModalAgregar() {
  fetch(`/agregar`)
    .then(response => response.text())
    .then(html => {
      document.getElementById('contenidoAgregar').innerHTML = html;
      new bootstrap.Modal(document.getElementById('modalAgregar')).show();
      setTimeout(() => {
        calcularPrecioVenta();
        document.getElementById("precio_costo")?.addEventListener("input", calcularPrecioVenta);
        document.getElementById("ganancia")?.addEventListener("input", calcularPrecioVenta);
      }, 200);
    });
}

function abrirModalEditar(id) {
  fetch(`/editar/${id}`)
    .then(response => response.text())
    .then(html => {
      document.getElementById('contenidoEditar').innerHTML = html;
      new bootstrap.Modal(document.getElementById('modalEditar')).show();
      setTimeout(() => {
        calcularPrecioVenta();
        document.getElementById("precio_costo")?.addEventListener("input", calcularPrecioVenta);
        document.getElementById("ganancia")?.addEventListener("input", calcularPrecioVenta);
      }, 200);
    });
}

function parsearNumero(valor) {
    if (!valor) return NaN;
    valor = valor.toString().trim();
    if (/^\d+(\.\d+)?$/.test(valor)) {
        return parseFloat(valor);
    }
    return parseFloat(valor.replace(/\./g, "").replace(",", "."));
}

function calcularPrecioVenta() {
    let costo = parsearNumero(document.getElementById("precio_costo")?.value);
    let ganancia = parsearNumero(document.getElementById("ganancia")?.value);
    if (!isNaN(costo) && !isNaN(ganancia)) {
        let precioVenta = costo * (1 + (ganancia / 100));
        if (document.getElementById("precio_venta")) {
            document.getElementById("precio_venta").value = precioVenta.toLocaleString("es-AR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
    } else if (document.getElementById("precio_venta")) {
        document.getElementById("precio_venta").value = "";
    }
}
</script>

<!-- Modal Agregar Producto -->
<div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="contenidoAgregar">
      <!-- Contenido cargado din√°micamente -->
    </div>
  </div>
</div>

<!-- Modal Editar Producto -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" id="contenidoEditar">
      <!-- Contenido cargado din√°micamente -->
    </div>
  </div>
</div>

{% endblock %}
