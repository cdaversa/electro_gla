{% extends "layout.html" %}
{% block title %}Lista de Precios{% endblock %}
{% block content %}
<h2>Lista de Precios</h2>

<input type="text" id="buscador" class="form-control mb-3" placeholder="üîç Buscar producto...">

<!-- üîπ Contenedor con scroll -->
<div style="max-height: 60vh; overflow-y: auto; border: 1px solid #ddd;">
<table class="table table-striped" id="tabla-precios">
<thead class="table-dark" style="position: sticky; top: 0;">
<tr>
    <th>Nombre</th>
    <th>Cantidad en Stock</th>
    <th>Precio Venta</th>
</tr>
</thead>
<tbody>
{% for p in lista %}
<tr data-nombre="{{ p['nombre'] }}" data-stock="{{ p['cantidad'] }}" 
    class="{% if p['cantidad'] == 0 %}table-danger{% endif %}">
    <td>{{ p['nombre'] }}</td>
    <td>{{ p['cantidad'] }}</td>
    <td>{{ p['precio_venta']|precio }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- üîπ Bot√≥n vender con color din√°mico -->
<div style="position: sticky; bottom: 10px; background: #fff; padding: 10px; border-top: 1px solid #ddd;">
    <button id="btn-vender" class="btn btn-secondary w-100" disabled>üõí Vender</button>
</div>

<script>
// ‚úÖ Buscador en tiempo real
document.getElementById("buscador").addEventListener("keyup", function () {
    let filtro = this.value.toLowerCase();
    document.querySelectorAll("#tabla-precios tbody tr").forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filtro) ? "" : "none";
    });
});

// ‚úÖ Selecci√≥n de fila con click
let filaSeleccionada = null;
const btnVender = document.getElementById("btn-vender");

document.querySelectorAll("#tabla-precios tbody tr").forEach(row => {
    row.addEventListener("click", function () {
        // Quitar selecci√≥n anterior
        if (filaSeleccionada) filaSeleccionada.classList.remove("table-primary");
        filaSeleccionada = this;
        filaSeleccionada.classList.add("table-primary");

        // ‚úÖ Verificar stock
        let stock = parseInt(filaSeleccionada.dataset.stock);
        if (stock <= 0) {
            btnVender.disabled = true;
            btnVender.className = "btn btn-secondary w-100"; // üîπ Gris cuando no hay stock
        } else {
            btnVender.disabled = false;
            btnVender.className = "btn btn-success w-100"; // üü¢ Verde si hay stock
        }
    });
});

// ‚úÖ Acci√≥n del bot√≥n vender con validaci√≥n
btnVender.addEventListener("click", function () {
    if (!filaSeleccionada) return;
    let stock = parseInt(filaSeleccionada.dataset.stock);
    if (stock <= 0) {
        alert("‚ö†Ô∏è No hay stock disponible para este producto.");
        return;
    }

    let nombre = filaSeleccionada.dataset.nombre;
    let cantidad = prompt("¬øCu√°ntas unidades deseas vender de " + nombre + "?", "1");

    if (cantidad && !isNaN(cantidad) && cantidad > 0) {
        if (cantidad > stock) {
            alert("‚ö†Ô∏è No puedes vender m√°s de lo que hay en stock (" + stock + ").");
            return;
        }
        window.location.href = "/vender/" + encodeURIComponent(nombre) + "/" + cantidad;
    }
});
</script>
{% endblock %}
